name: â›… CF Worker Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment untuk deploy'
        required: true
        default: 'prod'
        type: choice
        options:
          - dev
          - prod
          - one
      commit:
        description: 'Git commit atau branch'
        default: 'main'
        required: true

env:
  GIT_REF: ${{ github.event.inputs.commit || github.ref }}
  WORKERS_ENV: ''

jobs:
  deploy:
    name: ðŸš€ Deploy Worker ke CF
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ðŸ“¥ Checkout repo
        uses: actions/checkout@v3
        with:
          ref: ${{ env.GIT_REF }}
          fetch-depth: 0

      - name: âš™ï¸ Setup Node.js v20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ðŸ“¦ Install wrangler
        run: npm install -g wrangler

      - name: ðŸ›  Set environment dari input
        run: |
          echo "WORKERS_ENV=${{ github.event.inputs.environment }}" >> $GITHUB_ENV
          echo "COMMIT_SHA=${{ github.sha }}" >> $GITHUB_ENV

      - name: ðŸš€ Deploy ke Cloudflare
        run: wrangler deploy --env ${{ env.WORKERS_ENV }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}

      - name: ðŸŽ‰ Sukses!
        run: |
          echo "::notice title=Deploy Berhasil::Environment: $WORKERS_ENV, Commit: $GIT_REF"
