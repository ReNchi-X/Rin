name: â›… CF Worker

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'wrangler env to deploy to'
        required: true
        default: 'prod'
        type: choice
        options:
          - dev
          - prod
          - one
      commit:
        description: 'git tip commit to deploy'
        default: 'main'
        required: true

env:
  GIT_REF: ${{ github.event.inputs.commit || github.ref }}
  WORKERS_ENV: ''

jobs:
  deploy:
    name: ğŸš€ Deploy worker
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: ğŸ“¥ Checkout kode
        uses: actions/checkout@v3.3.0
        with:
          ref: ${{ env.GIT_REF }}
          fetch-depth: 0

      - name: ğŸ›  Set WORKERS_ENV dari input
        if: github.event.inputs.environment == 'prod' || github.event.inputs.environment == 'one'
        run: |
          echo "WORKERS_ENV=${WENV}" >> $GITHUB_ENV
          echo "COMMIT_SHA=${COMMIT_SHA}" >> $GITHUB_ENV
        env:
          WENV: ${{ github.event.inputs.environment }}
          COMMIT_SHA: ${{ github.sha }}

      - name: ğŸ· Set WORKERS_ENV jika tag
        if: github.ref_type == 'tag'
        run: |
          echo "WORKERS_ENV=prod" >> $GITHUB_ENV
          echo "COMMIT_SHA=${{ github.sha }}" >> $GITHUB_ENV

      - name: âš™ï¸ Setup Node.js v20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ Install wrangler
        run: npm install -g wrangler

      - name: ğŸš€ Deploy with wrangler
        run: wrangler publish --env ${{ env.WORKERS_ENV }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}

      - name: ğŸ¤ Notice
        run: |
          echo "::notice::Deployed to ${WORKERS_ENV} / ${GIT_REF} @ ${COMMIT_SHA}"
